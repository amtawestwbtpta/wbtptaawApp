<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Free WB GPF Calculator for West Bengal government employees to plan retirement savings. Calculate GPF corpus, contributions, and interest easily.">
    <meta name="keywords" content="WB GPF Calculator, General Provident Fund, retirement planning, government employee savings, GPF interest calculator, financial planning, retirement corpus">
    <meta name="author" content="WB GPF Calculator Team">
    <meta name="robots" content="index, follow">
    <title>WB GPF Calculator - Plan Your Retirement</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Include jsPDF library for PDF generation (includes html2canvas) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Include html2canvas explicitly for better control over rendering -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* Custom styles for select dropdown arrow */
        select {
            -webkit-appearance: none; /* Remove default arrow for Chrome/Safari */
            -moz-appearance: none;    /* Remove default arrow for Firefox */
            appearance: none;         /* Remove default arrow */
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="12" height="6"><path d="M0 0h12l-6 6z" fill="%239ca3af"/></svg>');
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 0.75rem;
        }
        /* Focus styles for inputs, selects, and textareas */
        input:focus, select:focus, textarea:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5); /* Tailwind blue-500 equivalent */
            border-color: #3b82f6; /* Tailwind blue-500 */
        }
        /* Table responsiveness */
        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch; /* For smoother scrolling on iOS */
        }
        /* Specific styles for smaller screens on table */
        @media (max-width: 640px) {
            .table-responsive table {
                font-size: 0.75rem;
                white-space: nowrap; /* Prevent wrapping in cells */
            }
            .table-responsive th, .table-responsive td {
                padding: 0.5rem;
            }
        }
        /* Inter font for better typography */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom table styling for elegance */
        .gpf-table th, .gpf-table td {
            border-bottom: 1px solid #e5e7eb; /* Light gray border */
            padding: 0.75rem; /* More padding */
            text-align: left;
        }
        .gpf-table thead th {
            background-color: #f9fafb; /* Light header background */
            font-weight: 600;
            color: #4b5563;
        }
        .gpf-table tbody tr:nth-child(even) {
            background-color: #f3f4f6; /* Alternating row colors */
        }
        .gpf-table tbody tr:hover {
            background-color: #e5e7eb; /* Hover effect */
        }
        /* Custom row classes for March and February */
        .gpf-table-row.march-month {
            background-color: #d1fae5; /* Tailwind green-100 */
        }
        .gpf-table-row.february-month {
            background-color: #fee2e2; /* Tailwind red-100 */
        }

        /* Styles for PDF content - ensure these are robust for html2canvas */
        .pdf-content-wrapper {
            font-family: 'Inter', sans-serif;
            color: #333;
            background-color: #fff;
            padding: 20px;
            box-sizing: border-box;
        }
        .pdf-content-wrapper h3 {
            font-size: 20px;
            font-weight: bold;
            text-align: center;
            margin-bottom: 15px;
            color: #1a202c; /* Tailwind gray-900 */
        }
        .pdf-content-wrapper p {
            font-size: 14px;
            text-align: center;
            margin-bottom: 15px;
            color: #4a5568; /* Tailwind gray-700 */
        }
        .pdf-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background-color: #fff;
            border: 1px solid #e2e8f0; /* Tailwind gray-200 */
            border-radius: 8px; /* Rounded corners for the table */
            overflow: hidden; /* Ensures rounded corners apply to content */
        }
        .pdf-table th, .pdf-table td {
            border: 1px solid #e2e8f0; /* Light gray border for cells */
            padding: 10px;
            text-align: left;
            font-size: 13px;
            color: #2d3748; /* Tailwind gray-800 */
        }
        .pdf-table thead th {
            background-color: #f7fafc; /* Tailwind gray-100 */
            font-weight: 600;
            color: #2d3748;
        }
        .pdf-table tbody tr:nth-child(even) {
            background-color: #edf2f7; /* Tailwind gray-100 */
        }
        .pdf-table-row.march-month-pdf {
            background-color: #d1fae5 !important; /* Tailwind green-100, !important to override */
        }
        .pdf-table-row.february-month-pdf {
            background-color: #fee2e2 !important; /* Tailwind red-100, !important to override */
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">
<header class="bg-gradient-to-r from-blue-700 to-blue-500 text-white text-center py-6 shadow-xl rounded-b-lg">
    <h1 class="text-2xl sm:text-3xl font-extrabold tracking-tight">WB GPF Calculator üìä</h1>
    <p class="mt-2 text-sm sm:text-base opacity-90">Plan your retirement with confidence and clarity</p>
</header>

<main class="flex-grow max-w-3xl mx-auto p-4 sm:p-6 w-full">
    <section class="bg-white rounded-xl shadow-lg p-6 mb-6 border border-gray-200">
        <div class="space-y-6">
            <div>
                <label for="opening" class="block text-sm font-medium text-gray-700 mb-1">üßÆ Opening Balance (‚Çπ)</label>
                <input type="number" id="opening" placeholder="e.g. 100000" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 transition duration-150 ease-in-out shadow-sm">
            </div>
            <div class="flex flex-col sm:flex-row gap-4">
                <label class="flex items-center space-x-2 cursor-pointer p-3 bg-blue-50 rounded-lg border border-blue-200 hover:bg-blue-100 transition duration-150 ease-in-out flex-grow shadow-sm">
                    <input type="radio" name="calcMode" value="full" checked class="text-blue-600 focus:ring-blue-500">
                    <span class="text-base font-medium text-blue-800">Full Period (Month-wise)</span>
                </label>
                <!-- Removed Single Financial Year option as per user request -->
            </div>
            <div id="dateInputs" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">üìÖ Start Date (dd/mm/yyyy)</label>
                    <div class="flex gap-2">
                        <select id="dojDay" class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 transition duration-150 ease-in-out shadow-sm">
                            <option value="">DD</option>
                        </select>
                        <select id="dojMonth" class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 transition duration-150 ease-in-out shadow-sm">
                            <option value="">MM</option>
                        </select>
                        <select id="dojYear" class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 transition duration-150 ease-in-out shadow-sm">
                            <option value="">YYYY</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">üìÖ End Date (dd/mm/yyyy)</label>
                    <div class="flex gap-2">
                        <select id="dorDay" class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 transition duration-150 ease-in-out shadow-sm">
                            <option value="">DD</option>
                        </select>
                        <select id="dorMonth" class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 transition duration-150 ease-in-out shadow-sm">
                            <option value="">MM</option>
                        </select>
                        <select id="dorYear" class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 transition duration-150 ease-in-out shadow-sm">
                            <option value="">YYYY</option>
                        </select>
                    </div>
                </div>
            </div>
            <!-- Removed singleYearInput div as per user request -->
            <div>
                <label for="subscription" class="block text-sm font-medium text-gray-700 mb-1">üí∞ Monthly GPF Subscription (‚Çπ)</label>
                <input type="number" id="subscription" placeholder="e.g. 5000" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 transition duration-150 ease-in-out shadow-sm">
            </div>
            <!-- Removed Partial Withdrawals input field completely as per user request -->
            <div id="errorMessage" class="text-red-700 bg-red-100 border border-red-400 p-3 rounded-lg text-sm hidden font-semibold" role="alert"></div>
            <button onclick="toggleInterestTable()" class="w-full p-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition duration-150 ease-in-out font-semibold shadow-md">üìù Edit Interest Rates</button>
            <div id="interestTable" class="hidden mt-4">
                <h4 class="text-lg font-semibold text-gray-800 mb-3">Interest Rate Table</h4>
                <div class="table-responsive rounded-lg border border-gray-200 shadow-sm">
                    <table id="rateTable" class="w-full bg-white gpf-table">
                        <thead class="bg-gray-50">
                        <tr><th class="p-3 text-sm font-semibold text-left">Year</th><th class="p-3 text-sm font-semibold text-left">March Rate (%)</th><th class="p-3 text-sm font-semibold text-left">July Rate (%)</th></tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            <button onclick="calculateGPF()" class="w-full p-4 bg-gradient-to-r from-blue-600 to-blue-800 text-white rounded-lg hover:from-blue-700 hover:to-blue-900 transition duration-150 ease-in-out font-bold text-lg shadow-lg transform hover:scale-105">üìà Calculate GPF</button>
        </div>

        <!-- Save & Print Buttons -->
        <div class="mt-6 flex justify-center gap-4">
            <!-- Removed Save as PDF button as per user request -->
            <button onclick="AndroidInterface.printNow()" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 shadow">
                üñ®Ô∏è Print PDF
            </button>
        </div>

    </section>

    <section id="gpfResult" class="hidden bg-white rounded-xl shadow-lg p-6 mb-6 border border-gray-200">
        <h3 id="resultHeader" class="text-xl font-bold text-gray-800 mb-4 text-center">üìÖ GPF Summary</h3>
        <p class="text-gray-600 text-sm mb-4 text-center">Scroll horizontally on smaller screens to view full table.</p>
        <div class="table-responsive rounded-lg border border-gray-200 shadow-sm">
            <table class="w-full bg-white gpf-table">
                <thead id="tableHeader" class="bg-gray-50">
                <tr>
                    <th class="p-3 text-sm font-semibold text-left">Period</th>
                    <th class="p-3 text-sm font-semibold text-left">Opening</th>
                    <th class="p-3 text-sm font-semibold text-left">Contribution</th>
                    <th class="p-3 text-sm font-semibold text-left">Interest</th>
                    <th class="p-3 text-sm font-semibold text-left">Withdrawal</th>
                    <th class="p-3 text-sm font-semibold text-left">Closing</th>
                </tr>
                </thead>
                <tbody id="gpfTableBody"></tbody>
            </table>
        </div>
        <!-- Removed Save as PDF button as per user request -->
    </section>

    <section id="summary" class="hidden bg-white rounded-xl shadow-lg p-6 mb-6 border border-gray-200">
        <h3 class="text-xl font-bold text-gray-800 mb-4 text-center">üí∞ Final Summary</h3>
        <div id="summaryGraphics" class="grid grid-cols-1 sm:grid-cols-3 gap-4">
            <div class="bg-gradient-to-br from-blue-600 to-blue-800 text-white p-5 rounded-lg text-center shadow-lg transform hover:scale-105 transition duration-200">
                <h4 class="text-sm font-semibold mb-2 opacity-90">Total Invested</h4>
                <p id="totalInvested" class="text-2xl sm:text-3xl font-bold"></p>
            </div>
            <div class="bg-gradient-to-br from-green-600 to-green-800 text-white p-5 rounded-lg text-center shadow-lg transform hover:scale-105 transition duration-200">
                <h4 class="text-sm font-semibold mb-2 opacity-90">Total Interest Earned</h4>
                <p id="totalInterest" class="text-2xl sm:text-3xl font-bold"></p>
            </div>
            <div class="bg-gradient-to-br from-yellow-400 to-yellow-600 text-gray-900 p-5 rounded-lg text-center shadow-lg transform hover:scale-105 transition duration-200">
                <h4 class="text-sm font-semibold mb-2 opacity-90">Total Corpus</h4>
                <p id="totalCorpus" class="text-2xl sm:text-3xl font-bold"></p>
                <p id="totalCorpusWords" class="text-xs sm:text-sm italic mt-2 opacity-90"></p>
            </div>
        </div>
        <button onclick="resetCalculator()" class="w-full p-4 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition duration-150 ease-in-out font-bold text-lg mt-6 shadow-md transform hover:scale-105">Start New Calculation</button>
    </section>

    <section class="bg-white rounded-xl shadow-lg p-6 mb-6 border border-gray-200">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">Use Cases for WB GPF Calculator</h3>
        <details class="border-b border-gray-200 py-2">
            <summary class="font-semibold text-gray-700 cursor-pointer hover:text-blue-600 transition duration-150 ease-in-out">Early-Career Planning</summary>
            <p class="text-sm text-gray-600 mt-2">New government employees can estimate their GPF growth by entering their starting balance, monthly contributions, and expected service years.</p>
        </details>
        <details class="border-b border-gray-200 py-2">
            <summary class="font-semibold text-gray-700 cursor-pointer hover:text-blue-600 transition duration-150 ease-in-out">Mid-Career Withdrawals</summary>
            <p class="text-sm text-gray-600 mt-2">Employees planning withdrawals for expenses like education or housing can input withdrawal amounts in JSON format to see their impact.</p>
        </details>
        <details class="py-2">
            <summary class="font-semibold text-gray-700 cursor-pointer hover:text-blue-600 transition duration-150 ease-in-out">Pre-Retirement Estimation</summary>
            <p class="text-sm text-gray-600 mt-2">Those nearing retirement can adjust interest rates and contributions to project their final GPF corpus.</p>
        </details>
    </section>

    <section class="bg-white rounded-xl shadow-lg p-6 mb-6 border border-gray-200">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">Frequently Asked Questions</h3>
        <details class="border-b border-gray-200 py-2">
            <summary class="font-semibold text-gray-700 cursor-pointer hover:text-blue-600 transition duration-150 ease-in-out">What is a General Provident Fund (GPF)?</summary>
            <p class="text-sm text-gray-600 mt-2">The General Provident Fund (GPF) is a savings scheme for West Bengal government employees, allowing salary contributions with attractive interest rates.</p>
        </details>
        <details class="border-b border-gray-200 py-2">
            <summary class="font-semibold text-gray-700 cursor-pointer hover:text-blue-600 transition duration-150 ease-in-out">How does this WB GPF Calculator work?</summary>
            <p class="text-sm text-gray-600 mt-2">Input your opening balance, monthly subscription, joining and retirement years or a single year, and withdrawals. It estimates contributions, interest, and total corpus.</p>
        </details>
        <details class="border-b border-gray-200 py-2">
            <summary class="font-semibold text-gray-700 cursor-pointer hover:text-blue-600 transition duration-150 ease-in-out">Can I edit the interest rates?</summary>
            <p class="text-sm text-gray-600 mt-2">Yes, click "Edit Interest Rates" to customize March and July rates for accurate projections.</p>
        </details>
        <details class="border-b border-gray-200 py-2">
            <summary class="font-semibold text-gray-700 cursor-pointer hover:text-blue-600 transition duration-150 ease-in-out">Who can use the WB GPF Calculator?</summary>
            <p class="text-sm text-gray-600 mt-2">It‚Äôs for West Bengal government employees enrolled in GPF, ideal for retirement planning.</p>
        </details>
        <details class="border-b border-gray-200 py-2">
            <summary class="font-semibold text-gray-700 cursor-pointer hover:text-blue-600 transition duration-150 ease-in-out">Are GPF withdrawals taxable?</summary>
            <p class="text-sm text-gray-600 mt-2">GPF withdrawals are generally tax-free after five years of service or at retirement, subject to conditions. Consult a tax advisor.</p>
        </details>
        <details class="py-2">
            <summary class="font-semibold text-gray-700 cursor-pointer hover:text-blue-600 transition duration-150 ease-in-out">How accurate are the projections?</summary>
            <p class="text-sm text-gray-600 mt-2">Projections are based on user inputs and historical/projected rates. Actual GPF returns may vary due to policy changes.</p>
        </details>
    </section>
</main>

<footer class="bg-gray-800 text-white text-center py-6 mt-auto shadow-inner">
    <h3 class="text-lg font-semibold mb-3">Plan Your Financial Future</h3>
    <p class="text-sm max-w-2xl mx-auto px-4">Our <strong>WB GPF Calculator</strong> helps West Bengal government employees plan their retirement with confidence. Calculate your GPF savings, including interest earned and total retirement corpus.</p>
    <p class="text-sm mt-2">Keywords: WB GPF Calculator, General Provident Fund, retirement savings calculator, government employee benefits, GPF interest rates.</p>
</footer>

<script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "SoftwareApplication",
        "name": "WB GPF Calculator",
        "operatingSystem": "Web",
        "applicationCategory": "FinancialApplication",
        "description": "Free WB GPF Calculator for West Bengal government employees to estimate savings, contributions, and retirement corpus.",
        "url": "https://yourwebsite.com/wb-gpf-calculator",
        "offers": {
            "@type": "Offer",
            "price": "0",
            "priceCurrency": "INR"
        },
        "FAQPage": {
            "@type": "FAQPage",
            "mainEntity": [
                {
                    "@type": "Question",
                    "name": "What is a General Provident Fund (GPF)?",
                    "acceptedAnswer": {
                        "@type": "Answer",
                        "text": "The General Provident Fund (GPF) is a savings scheme for West Bengal government employees, allowing salary contributions with attractive interest rates."
                    }
                },
                {
                    "@type": "Question",
                    "name": "How does this WB GPF Calculator work?",
                    "acceptedAnswer": {
                        "@type": "Answer",
                        "text": "Input your opening balance, monthly subscription, joining and retirement years or a single year, and withdrawals. It estimates contributions, interest, and total corpus."
                    }
                },
                {
                    "@type": "Question",
                    "name": "Are GPF withdrawals taxable?",
                    "acceptedAnswer": {
                        "@type": "Answer",
                        "text": "GPF withdrawals are generally tax-free after five years of service or at retirement, subject to conditions. Consult a tax advisor."
                    }
                }
            ]
        }
    }
</script>
<script>
    // Default interest rates. This data can be updated by the user in the UI.
    // Rates are per financial year (March to February).
    let iR = {
        ...Object.fromEntries(Array.from({ length: 15 }, (_, i) => [1986 + i, { march: 12, july: 12 }])), // Example historical rates
        2016: { march: 8.1, july: 8.1 },
        2017: { march: 8, july: 7.8 },
        2018: { march: 7.6, july: 7.6 },
        2019: { march: 7.9, july: 7.9 },
        2020: { march: 7.1, july: 7.1 },
        // Future years default to 7.1%
        ...Object.fromEntries(Array.from({ length: 50 }, (_, i) => [2021 + i, { march: 7.1, july: 7.1 }]))
    };

    // Global array to store calculated GPF data for each year/month
    let gpfCalculatedData = [];

    /**
     * Populates the day, month, and year dropdowns for start and end dates.
     */
    function populateDateDropdowns() {
        const currentYear = new Date().getFullYear();
        const startYear = 1980; // Start year for dropdowns
        const endYear = 2100;   // End year for dropdowns

        const months = [
            { value: 0, text: 'January' }, { value: 1, text: 'February' }, { value: 2, text: 'March' },
            { value: 3, text: 'April' }, { value: 4, text: 'May' }, { value: 5, text: 'June' },
            { value: 6, text: 'July' }, { value: 7, text: 'August' }, { value: 8, text: 'September' },
            { value: 9, text: 'October' }, { value: 10, text: 'November' }, { value: 11, text: 'December' }
        ];

        /**
         * Helper to populate days dropdown.
         * @param {HTMLSelectElement} selectElement - The select element to populate.
         */
        const populateDays = (selectElement) => {
            selectElement.innerHTML = '<option value="">DD</option>';
            for (let i = 1; i <= 31; i++) {
                let option = document.createElement("option");
                option.value = i;
                option.textContent = i;
                selectElement.appendChild(option);
            }
        };

        /**
         * Helper to populate months dropdown.
         * @param {HTMLSelectElement} selectElement - The select element to populate.
         */
        const populateMonths = (selectElement) => {
            selectElement.innerHTML = '<option value="">MM</option>';
            months.forEach(month => {
                let option = document.createElement("option");
                option.value = month.value; // Use 0-indexed month value
                option.textContent = month.text;
                selectElement.appendChild(option);
            });
        };

        /**
         * Helper to populate years dropdown.
         * @param {HTMLSelectElement} selectElement - The select element to populate.
         */
        const populateYears = (selectElement) => {
            selectElement.innerHTML = '<option value="">YYYY</option>';
            for (let y = startYear; y <= endYear; y++) {
                let option = document.createElement("option");
                option.value = y;
                option.textContent = y;
                selectElement.appendChild(option);
            }
        };

        // Populate Start Date dropdowns
        populateDays(document.getElementById("dojDay"));
        populateMonths(document.getElementById("dojMonth"));
        populateYears(document.getElementById("dojYear"));

        // Populate End Date dropdowns
        populateDays(document.getElementById("dorDay"));
        populateMonths(document.getElementById("dorMonth"));
        populateYears(document.getElementById("dorYear"));
    }

    /**
     * Fetches interest rates for a given range of years.
     * Currently, it uses the predefined `iR` object. In a real application, this could fetch from an API.
     * @param {number} startYear - The starting year.
     * @param {number} endYear - The ending year.
     * @returns {Promise<Object>} A promise that resolves with an object containing interest rates per year.
     */
    async function fetchIR(startYear, endYear) {
        try {
            let ratesForRange = {};
            for (let y = startYear; y <= endYear; y++) {
                // Use existing rate or default to 7.1% if not found
                ratesForRange[y] = iR[y] || { march: 7.1, july: 7.1 };
            }
            return ratesForRange;
        } catch (e) {
            console.error("Error fetching interest rates:", e.message);
            // Fallback to default rates or a predefined set if fetch fails
            return iR;
        }
    }

    /**
     * Toggles the visibility of the interest rate table.
     */
    function toggleInterestTable() {
        try {
            let table = document.getElementById("interestTable");
            table.classList.toggle("hidden");
            if (!table.classList.contains("hidden")) {
                generateInterestTable(); // Generate table content when shown
            }
        } catch (e) {
            console.error("Error toggling interest table:", e.message);
        }
    }

    /**
     * Generates and populates the interest rate table based on selected years.
     */
    async function generateInterestTable() {
        try {
            const dojYear = parseInt(document.getElementById("dojYear").value);
            const dorYear = parseInt(document.getElementById("dorYear").value);

            if (isNaN(dojYear) || isNaN(dorYear)) {
                displayErrorMessage("Please select valid Start and End Dates for the interest table.");
                return;
            }
            const startYearForRates = dojYear;
            const endYearForRates = dorYear;

            // Fetch and update global interest rates
            let fetchedRates = await fetchIR(startYearForRates, endYearForRates);
            iR = { ...iR, ...fetchedRates }; // Merge fetched rates with existing ones

            let tableBody = document.querySelector("#rateTable tbody");
            tableBody.innerHTML = ""; // Clear existing rows

            // Populate the table with editable interest rates
            for (let y = startYearForRates; y <= endYearForRates; y++) {
                // Ensure there's an entry for the year, defaulting if necessary
                iR[y] = iR[y] || { march: 7.1, july: 7.1 };
                let row = document.createElement("tr");
                row.innerHTML = `
                    <td class="p-3 border-b border-gray-100">${y}-${y + 1}</td>
                    <td class="p-3 border-b border-gray-100">
                        <input type="number" min="0" max="20" step="0.01" value="${iR[y].march}"
                               class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 transition duration-150 ease-in-out"
                               onchange="updateInterestRate(${y},'march',this.value)">
                    </td>
                    <td class="p-3 border-b border-gray-100">
                        <input type="number" min="0" max="20" step="0.01" value="${iR[y].july}"
                               class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 transition duration-150 ease-in-out"
                               onchange="updateInterestRate(${y},'july',this.value)">
                    </td>
                `;
                tableBody.appendChild(row);
            }
        } catch (e) {
            console.error("Error generating interest table:", e.message);
            displayErrorMessage("Error generating interest table: " + e.message);
        }
    }

    /**
     * Updates the interest rate in the global `iR` object.
     * @param {number} year - The financial year for which to update the rate (e.g., 2023 for 2023-24).
     * @param {string} period - 'march' or 'july' indicating the rate period.
     * @param {string} value - The new rate value as a string.
     */
    function updateInterestRate(year, period, value) {
        try {
            iR[year] = iR[year] || {};
            // Parse float, default to 7.1 if invalid
            iR[year][period] = parseFloat(value) || 7.1;
            // Re-calculate GPF if the interest rate changes and a calculation has already been performed
            if (gpfCalculatedData.length > 0) {
                calculateGPF(); // Re-run the main calculation
            }
        } catch (e) {
            console.error("Error updating interest rate:", e.message);
        }
    }

    /**
     * Converts a number into Indian currency words (Lakh, Crore).
     * @param {number} n - The number to convert.
     * @returns {string} The number in words, e.g., "one lakh twenty thousand only".
     */
    function num2Words(n) {
        if (n === 0) return "zero";
        // Arrays for words
        const units = ['', 'one', 'two', 'three', 'four', 'five', 'six', 'seven', 'eight', 'nine', 'ten',
                       'eleven', 'twelve', 'thirteen', 'fourteen', 'fifteen', 'sixteen', 'seventeen',
                       'eighteen', 'nineteen'];
        const tens = ['', '', 'twenty', 'thirty', 'forty', 'fifty', 'sixty', 'seventy', 'eighty', 'ninety'];
        const denominations = ['', 'thousand', 'lakh', 'crore']; // Indian denominations

        /**
         * Converts a number less than 1000 into words.
         * @param {number} num - The number to convert.
         * @returns {string} The number in words.
         */
        function convertLessThanThousand(num) {
            let s = '';
            if (num > 99) {
                s += units[Math.floor(num / 100)] + ' hundred';
                num %= 100;
                if (num > 0) s += ' ';
            }
            if (num > 19) {
                s += tens[Math.floor(num / 10)];
                num %= 10;
                if (num > 0) s += ' ' + units[num];
            } else if (num > 0) {
                s += units[num];
            }
            return s.trim();
        }

        let parts = [];
        let i = 0;
        // Process number in groups of 2 (except for the first group which can be 3 digits)
        // This is specific to Indian numbering system (thousands, lakhs, crores)
        let tempN = Math.floor(Math.abs(n)); // Work with absolute integer part
        if (tempN === 0) return "zero only";

        while (tempN > 0) {
            let chunk;
            if (i === 0) { // First chunk for hundreds
                chunk = tempN % 1000;
                tempN = Math.floor(tempN / 1000);
            } else { // Subsequent chunks for tens (lakhs, crores)
                chunk = tempN % 100;
                tempN = Math.floor(tempN / 100);
            }

            if (chunk > 0) {
                let chunkWords = convertLessThanThousand(chunk);
                if (denominations[i]) {
                    parts.push(chunkWords + ' ' + denominations[i]);
                } else {
                    parts.push(chunkWords);
                }
            }
            i++;
        }

        return parts.reverse().join(' ').trim() + ' only';
    }

    /**
     * Displays an error message in the dedicated error message div.
     * @param {string} message - The error message to display.
     */
    function displayErrorMessage(message) {
        const errorMessageDiv = document.getElementById("errorMessage");
        errorMessageDiv.textContent = message;
        errorMessageDiv.classList.remove("hidden");
        // Scroll to the error message for visibility
        errorMessageDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    /**
     * Hides the error message div.
     */
    function hideErrorMessage() {
        const errorMessageDiv = document.getElementById("errorMessage");
        errorMessageDiv.classList.add("hidden");
        errorMessageDiv.textContent = "";
    }

    /**
     * Validates a date.
     * @param {number} year
     * @param {number} month (0-indexed)
     * @param {number} day
     * @returns {boolean} True if the date is valid, false otherwise.
     */
    function isValidDate(year, month, day) {
        const d = new Date(year, month, day);
        return d.getFullYear() === year && d.getMonth() === month && d.getDate() === day;
    }

    /**
     * Renders the GPF summary table from the gpfCalculatedData array.
     * Makes Contribution and Withdrawal fields editable for 'full' mode.
     */
    function renderGPFTable() {
        const gpfTableBody = document.getElementById("gpfTableBody");
        gpfTableBody.innerHTML = ""; // Clear previous results

        // calcMode is always 'full' now
        let totalInvested = 0;
        let totalInterestEarned = 0;
        let finalCorpus = 0;

        gpfCalculatedData.forEach((data, index) => {
            let row = document.createElement("tr");
            let rowClass = "";
            if (data.periodLabel.startsWith("March")) {
                rowClass = "march-month"; // Light green
            } else if (data.periodLabel.startsWith("February")) {
                rowClass = "february-month"; // Light red
            }
            row.className = `gpf-table-row ${rowClass}`;

            // Period column (Month or Year)
            const periodCell = document.createElement("td");
            periodCell.className = "p-3 border-b border-gray-100";
            periodCell.textContent = data.periodLabel; // Use the pre-formatted label
            row.appendChild(periodCell);

            // Opening Balance (display only)
            const openingCell = document.createElement("td");
            openingCell.className = "p-3 border-b border-gray-100";
            openingCell.textContent = `‚Çπ${Math.round(data.opening).toFixed(0)}`;
            row.appendChild(openingCell);

            // Contribution (editable for full period)
            const contributionCell = document.createElement("td");
            contributionCell.className = "p-3 border-b border-gray-100";
            const contributionInput = document.createElement("input");
            contributionInput.type = "number";
            contributionInput.min = "0";
            contributionInput.value = Math.round(data.contribution).toFixed(0);
            contributionInput.className = "w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 transition duration-150 ease-in-out";
            contributionInput.onchange = (event) => handleTableEdit(event.target, index, 'contribution');
            contributionCell.appendChild(contributionInput);
            row.appendChild(contributionCell);

            // Interest (display only)
            const interestCell = document.createElement("td");
            interestCell.className = "p-3 border-b border-gray-100";
            interestCell.textContent = `‚Çπ${Math.round(data.interest).toFixed(0)}`;
            row.appendChild(interestCell);

            // Withdrawal (editable for full period)
            const withdrawalCell = document.createElement("td");
            withdrawalCell.className = "p-3 border-b border-gray-100";
            const withdrawalInput = document.createElement("input");
            withdrawalInput.type = "number";
            withdrawalInput.min = "0";
            withdrawalInput.value = Math.round(data.withdrawal).toFixed(0);
            withdrawalInput.className = "w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 transition duration-150 ease-in-out";
            withdrawalInput.onchange = (event) => handleTableEdit(event.target, index, 'withdrawal');
            withdrawalCell.appendChild(withdrawalInput);
            row.appendChild(withdrawalCell);

            // Closing Balance (display only)
            const closingCell = document.createElement("td");
            closingCell.className = "p-3 border-b border-gray-100";
            closingCell.textContent = `‚Çπ${Math.round(data.closing).toFixed(0)}`;
            row.appendChild(closingCell);

            gpfTableBody.appendChild(row);

            // Update totals for summary
            totalInvested += data.contribution;
            totalInterestEarned += data.interest;
            finalCorpus = data.closing; // Final corpus is the closing balance of the last entry
        });

        // Update summary graphics
        document.getElementById("totalInvested").textContent = `‚Çπ${Math.round(totalInvested).toFixed(0)}`;
        document.getElementById("totalInterest").textContent = `‚Çπ${Math.round(totalInterestEarned).toFixed(0)}`;
        document.getElementById("totalCorpus").textContent = `‚Çπ${Math.round(finalCorpus).toFixed(0)}`;
        document.getElementById("totalCorpusWords").textContent = num2Words(Math.round(finalCorpus));

        // Display results sections
        document.getElementById("gpfResult").classList.remove("hidden");
        document.getElementById("summary").classList.remove("hidden");
    }

    /**
     * Handles changes in the editable GPF summary table.
     * @param {HTMLInputElement} element - The input element that was changed.
     * @param {number} index - The index of the row (month) in gpfCalculatedData.
     * @param {string} field - The field that was changed ('contribution' or 'withdrawal').
     */
    function handleTableEdit(element, index, field) {
        const newValue = parseFloat(element.value);
        if (isNaN(newValue) || newValue < 0) {
            displayErrorMessage(`Invalid amount entered for ${field}. Please enter a positive number.`);
            // Revert to previous valid value if input is invalid
            element.value = Math.round(gpfCalculatedData[index][field]).toFixed(0);
            return;
        }

        // Update the global data array, rounding the new value
        gpfCalculatedData[index][field] = Math.round(newValue);

        // Trigger recalculation from this point onwards
        recalculateGPFFromIndex(index);
    }

    /**
     * Recalculates GPF data from a specific index in the gpfCalculatedData array.
     * This is used when a table cell is edited.
     * @param {number} startIndex - The index from which to start recalculation.
     */
    function recalculateGPFFromIndex(startIndex) {
        // Determine the starting balance for recalculation
        // If it's the first row, use the initial opening balance from the input.
        // Otherwise, use the closing balance of the previous month's data.
        let currentRunningBalance = startIndex === 0 ?
            Math.round(parseFloat(document.getElementById("opening").value) || 0) :
            Math.round(gpfCalculatedData[startIndex - 1].closing);

        const monthsInOrder = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];

        // Iterate from the changed index to the end, recalculating each month's data
        for (let i = startIndex; i < gpfCalculatedData.length; i++) {
            let data = gpfCalculatedData[i];

            // Set the opening balance for the current row based on the running balance from the previous month/iteration
            data.opening = currentRunningBalance;

            let effectiveContribution = data.contribution; // Use the potentially edited contribution
            let effectiveWithdrawal = data.withdrawal;     // Use the potentially edited withdrawal

            // Apply contribution and withdrawal to the running balance
            currentRunningBalance += effectiveContribution;
            currentRunningBalance -= effectiveWithdrawal;

            // Determine financial year for March-Feb cycle for interest rate lookup
            const [monthName, yearStr] = data.periodLabel.split(' ');
            const year = parseInt(yearStr);
            const currentMonthIndex = monthsInOrder.indexOf(monthName);

            let financialYear;
            if (currentMonthIndex >= 2) { // March (index 2) to December (index 11)
                financialYear = year;
            } else { // January (index 0) and February (index 1) belong to the previous financial year
                financialYear = year - 1;
            }

            // Ensure interest rates for the financial year are available, defaulting if not set
            iR[financialYear] = iR[financialYear] || { march: 7.1, july: 7.1 };

            // Determine the applicable interest rate for the current month
            let currentRate;
            if (currentMonthIndex >= 6 || currentMonthIndex < 2) { // July (index 6) to Feb (index 1)
                currentRate = iR[financialYear].july || 7.1;
            } else { // March (index 2) to June (index 5)
                currentRate = iR[financialYear].march || 7.1;
            }
            const monthlyRate = currentRate / 12 / 100;

            // Calculate interest on the 'currentRunningBalance' after contributions/withdrawals
            let interestEarned = currentRunningBalance * monthlyRate;
            interestEarned = Math.round(interestEarned); // Round interest to nearest whole rupee

            // Update the data object for the current row
            data.interest = interestEarned;
            currentRunningBalance += interestEarned; // Add interest to the running balance
            data.closing = currentRunningBalance; // Update closing balance for this row

            // Check for negative balance after all operations for the month
            if (data.closing < 0) {
                displayErrorMessage(`Negative balance detected in ${data.periodLabel}. Please check your withdrawals and contributions.`);
                // Stop recalculation if a negative balance occurs
                return; // Exit the function to prevent further incorrect calculations
            }
        }

        renderGPFTable(); // Re-render the entire table with updated data
    }


    /**
     * Calculates the GPF based on user inputs and displays the results.
     */
    async function calculateGPF() {
        hideErrorMessage(); // Clear previous errors

        try {
            const monthlySubscription = parseFloat(document.getElementById("subscription").value);
            let openingBalance = parseFloat(document.getElementById("opening").value) || 0;

            // Input Validations
            if (isNaN(monthlySubscription) || monthlySubscription <= 0) {
                displayErrorMessage("Please enter a valid Monthly GPF Subscription (a positive number).");
                return;
            }
            if (openingBalance < 0) {
                displayErrorMessage("Opening Balance cannot be negative.");
                return;
            }

            const dojDay = parseInt(document.getElementById("dojDay").value);
            const dojMonth = parseInt(document.getElementById("dojMonth").value);
            const dojYear = parseInt(document.getElementById("dojYear").value);
            const dorDay = parseInt(document.getElementById("dorDay").value);
            const dorMonth = parseInt(document.getElementById("dorMonth").value);
            const dorYear = parseInt(document.getElementById("dorYear").value);

            if (isNaN(dojDay) || isNaN(dojMonth) || isNaN(dojYear) ||
                isNaN(dorDay) || isNaN(dorMonth) || isNaN(dorYear)) {
                displayErrorMessage("Please select complete Start and End Dates.");
                return;
            }

            if (!isValidDate(dojYear, dojMonth, dojDay)) {
                displayErrorMessage("Invalid Start Date. Please check day, month, and year.");
                return;
            }
            if (!isValidDate(dorYear, dorMonth, dorDay)) {
                displayErrorMessage("Invalid End Date. Please check day, month, and year.");
                return;
            }

            const startDate = new Date(dojYear, dojMonth, dojDay);
            const endDate = new Date(dorYear, dorMonth, dorDay);

            if (startDate > endDate) {
                displayErrorMessage("Start Date must be before or the same as End Date.");
                return;
            }

            gpfCalculatedData = []; // Clear previous results

            document.getElementById("resultHeader").textContent = `üìÖ GPF Monthly Summary from ${startDate.toLocaleDateString()} to ${endDate.toLocaleDateString()}`;
            document.getElementById("tableHeader").innerHTML = `<tr>
                <th class="p-3 text-sm font-semibold text-left">Period</th>
                <th class="p-3 text-sm font-semibold text-left">Opening</th>
                <th class="p-3 text-sm font-semibold text-left">Contribution</th>
                <th class="p-3 text-sm font-semibold text-left">Interest</th>
                <th class="p-3 text-sm font-semibold text-left">Withdrawal</th>
                <th class="p-3 text-sm font-semibold text-left">Closing</th>
            </tr>`;

            // Loop month by month
            let currentDate = new Date(startDate.getFullYear(), startDate.getMonth(), 1); // Start from the 1st of the start month
            const endMonthDate = new Date(endDate.getFullYear(), endDate.getMonth(), 1); // End at the 1st of the end month

            let currentRunningBalance = Math.round(openingBalance); // Initialize running balance, rounded

            while (currentDate <= endMonthDate) {
                // Store the opening balance for the current month's row *before* transactions
                const openingBalanceForCurrentRow = currentRunningBalance;

                // Determine the financial year for the current month (March-Feb cycle)
                let financialYear;
                // Date.getMonth() returns 0 for Jan, 1 for Feb, ..., 11 for Dec
                if (currentDate.getMonth() >= 2) { // March (index 2) to December (index 11)
                    financialYear = currentDate.getFullYear();
                } else { // January (index 0) and February (index 1) belong to the previous financial year
                    financialYear = currentDate.getFullYear() - 1;
                }

                // Ensure interest rates for the financial year are available, defaulting if not set
                iR[financialYear] = iR[financialYear] || { march: 7.1, july: 7.1 };

                // Determine the applicable interest rate for the current month based on the March-Feb financial year
                let currentRate;
                if (currentDate.getMonth() >= 6 || currentDate.getMonth() < 2) { // July (index 6) to Feb (index 1)
                    currentRate = iR[financialYear].july || 7.1;
                } else { // March (index 2) to June (index 5)
                    currentRate = iR[financialYear].march || 7.1;
                }
                const monthlyRate = currentRate / 12 / 100;

                let currentContribution = monthlySubscription;
                let currentWithdrawal = 0; // Withdrawals are handled via table edits, not initial input

                // Apply contribution and withdrawal to the running balance
                currentRunningBalance += currentContribution;
                currentRunningBalance -= currentWithdrawal;

                // Check for negative balance *after* contribution and withdrawal, *before* interest
                if (currentRunningBalance < 0) {
                    displayErrorMessage(`Withdrawal of ‚Çπ${currentWithdrawal.toFixed(0)} on ${currentDate.toLocaleDateString()} would result in a negative balance. Please adjust.`);
                    return;
                }

                // Calculate interest on the balance *after* contributions and withdrawals for the month
                let interestEarned = currentRunningBalance * monthlyRate;
                interestEarned = Math.round(interestEarned); // Round interest to nearest whole rupee

                // Add the calculated interest to the running balance
                currentRunningBalance += interestEarned;

                // Only add to gpfCalculatedData if it's within the actual date range (day-wise)
                // This ensures that if start/end dates are mid-month, only relevant months are shown.
                // The loop iterates month by month from the 1st, so we check if the 1st of the current month
                // is within the user's selected date range.
                if (currentDate >= startDate && currentDate.setHours(0,0,0,0) <= endDate.setHours(0,0,0,0)) {
                    gpfCalculatedData.push({
                        periodLabel: currentDate.toLocaleString('default', { month: 'long', year: 'numeric' }),
                        opening: openingBalanceForCurrentRow,
                        contribution: currentContribution,
                        interest: interestEarned,
                        withdrawal: currentWithdrawal,
                        closing: currentRunningBalance
                    });
                }

                // Move to the next month
                currentDate.setMonth(currentDate.getMonth() + 1);
            }

            renderGPFTable(); // Render the table from the populated gpfCalculatedData
            document.getElementById("gpfResult").scrollIntoView({ behavior: 'smooth', block: 'start' });

        } catch (e) {
            console.error("Error calculating GPF:", e);
            displayErrorMessage("An unexpected error occurred during calculation: " + e.message);
        }
    }

    /**
     * Resets the calculator to its initial state, clearing inputs and hiding results.
     */
    function resetCalculator() {
        document.getElementById("opening").value = "";
        document.getElementById("subscription").value = "";

        // Reset date dropdowns
        document.getElementById("dojDay").value = "";
        document.getElementById("dojMonth").value = "";
        document.getElementById("dojYear").value = "";
        document.getElementById("dorDay").value = "";
        document.getElementById("dorMonth").value = "";
        document.getElementById("dorYear").value = "";

        document.getElementById("dateInputs").classList.remove("hidden");

        document.getElementById("gpfResult").classList.add("hidden");
        document.getElementById("summary").classList.add("hidden");
        document.getElementById("interestTable").classList.add("hidden");
        hideErrorMessage(); // Clear any error messages
        gpfCalculatedData = []; // Clear stored data

        // Scroll to the top of the main content
        document.querySelector('main').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    /**
     * Generates and saves the GPF results table to a PDF.
     */
    async function saveGPFResultsAsPDF() {
        // Ensure jsPDF and html2canvas are loaded
        if (typeof window.jspdf === 'undefined' || typeof window.html2canvas === 'undefined') {
            displayErrorMessage("PDF generation libraries not loaded. Please try again or check your internet connection.");
            return;
        }

        const { jsPDF } = window.jspdf;
        const gpfResultSection = document.getElementById('gpfResult');

        if (!gpfResultSection || gpfResultSection.classList.contains('hidden')) {
            displayErrorMessage("No GPF results to save. Please calculate GPF first.");
            return;
        }

        // Create a temporary container for PDF rendering to avoid modifying the live DOM
        const tempPdfContent = document.createElement('div');
        tempPdfContent.className = 'pdf-content-wrapper'; // Apply a class for PDF specific styling
        tempPdfContent.style.width = '794px'; // A4 width in pixels (approx for 72dpi, adjust as needed)

        // Create the table structure for PDF
        const pdfTable = document.createElement('table');
        pdfTable.className = 'pdf-table'; // Apply a class for PDF table styling

        const pdfTableHeader = document.createElement('thead');
        pdfTableHeader.innerHTML = `
            <tr>
                <th>Period</th>
                <th>Opening</th>
                <th>Contribution</th>
                <th>Interest</th>
                <th>Withdrawal</th>
                <th>Closing</th>
            </tr>
        `;
        pdfTable.appendChild(pdfTableHeader);

        const pdfTableBody = document.createElement('tbody');
        gpfCalculatedData.forEach((data, index) => {
            const row = document.createElement('tr');
            let rowClass = "";
            if (data.periodLabel.startsWith("March")) {
                rowClass = "march-month-pdf"; // Specific class for PDF March rows
            } else if (data.periodLabel.startsWith("February")) {
                rowClass = "february-month-pdf"; // Specific class for PDF February rows
            }
            row.className = rowClass; // Apply the class

            row.innerHTML = `
                <td>${data.periodLabel}</td>
                <td>‚Çπ${Math.round(data.opening).toFixed(0)}</td>
                <td>‚Çπ${Math.round(data.contribution).toFixed(0)}</td>
                <td>‚Çπ${Math.round(data.interest).toFixed(0)}</td>
                <td>‚Çπ${Math.round(data.withdrawal).toFixed(0)}</td>
                <td>‚Çπ${Math.round(data.closing).toFixed(0)}</td>
            `;
            pdfTableBody.appendChild(row);
        });
        pdfTable.appendChild(pdfTableBody);

        tempPdfContent.appendChild(pdfTable);

        // Append to body temporarily to allow html2canvas to render styles
        document.body.appendChild(tempPdfContent);

        try {
            const canvas = await html2canvas(tempPdfContent, {
                scale: 2, // Increase scale for better resolution in PDF
                useCORS: true, // Important for images loaded from other origins, if any
                logging: true, // Enable logging for debugging html2canvas issues
                windowWidth: tempPdfContent.scrollWidth, // Capture full width of the content
                windowHeight: tempPdfContent.scrollHeight // Capture full height of the content
            });

            const imgData = canvas.toDataURL('image/png');
            const pdf = new jsPDF('p', 'pt', 'a4');
            const imgWidth = pdf.internal.pageSize.getWidth(); // A4 width in points
            const pageHeight = pdf.internal.pageSize.getHeight(); // A4 height in points
            let imgHeight = canvas.height * imgWidth / canvas.width;
            let heightLeft = imgHeight;
            let position = 0;

            // Add image to PDF, handling multiple pages if content is too long
            pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
            heightLeft -= pageHeight;

            while (heightLeft >= 0) {
                position = heightLeft - imgHeight;
                pdf.addPage();
                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;
            }

            pdf.save('WB_GPF_Calculator_Results.pdf');

        } catch (e) {
            console.error("Error generating PDF:", e);
            displayErrorMessage("Failed to generate PDF. Please ensure all data is valid and try again.");
        } finally {
            // Clean up the temporary content
            if (tempPdfContent.parentNode) {
                tempPdfContent.parentNode.removeChild(tempPdfContent);
            }
        }
    }


    // Expose functions to the global scope for HTML onclick attributes
    window.calculateGPF = calculateGPF;
    window.toggleInterestTable = toggleInterestTable;
    window.updateInterestRate = updateInterestRate; // Make sure this is accessible
    window.resetCalculator = resetCalculator;
    window.handleTableEdit = handleTableEdit; // Expose for table edits
    window.saveGPFResultsAsPDF = saveGPFResultsAsPDF; // Expose PDF save function

    // Initialize dropdowns when the page loads
    populateDateDropdowns();
</script>
</body>
</html>
